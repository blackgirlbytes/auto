name: Test Email Flow (Send to rizel@block.xyz only)

on:
  # Manual trigger only - for testing
  workflow_dispatch:
    inputs:
      day:
        description: 'Challenge day number (1-17)'
        required: true
        default: '1'

jobs:
  test-email-flow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Debug Railway Configuration
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
          RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT || 'production' }}
        run: |
          echo "ðŸ” Railway Configuration Debug:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "RAILWAY_TOKEN: ${RAILWAY_TOKEN:+âœ… Set (${#RAILWAY_TOKEN} chars)}"
          echo "RAILWAY_PROJECT_ID: ${RAILWAY_PROJECT_ID:-âŒ Not set}"
          echo "RAILWAY_SERVICE_ID: ${RAILWAY_SERVICE_ID:-âš ï¸  Not set (optional)}"
          echo "RAILWAY_ENVIRONMENT: ${RAILWAY_ENVIRONMENT:-production}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "âŒ ERROR: RAILWAY_TOKEN is required!"
            exit 1
          fi
          
          if [ -z "$RAILWAY_PROJECT_ID" ]; then
            echo "âš ï¸  WARNING: RAILWAY_PROJECT_ID not set. Railway CLI may not find your project."
            echo "   Add it to GitHub Secrets for reliable operation."
          fi
      
      - name: Test Railway Connection
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME || 'frosty-agent-forge' }}
          RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT || 'production' }}
        run: |
          echo "ðŸ§ª Testing Railway SSH connection..."
          echo "   Service: ${RAILWAY_SERVICE_NAME}"
          echo "   Environment: ${RAILWAY_ENVIRONMENT}"
          echo "   Token length: ${#RAILWAY_TOKEN} chars"
          echo ""
          
          # Railway CLI quirk: --project and --service flags ignore RAILWAY_TOKEN
          # Use service name only (Railway infers project from token)
          RAILWAY_CMD="railway ssh --service ${RAILWAY_SERVICE_NAME} --environment ${RAILWAY_ENVIRONMENT}"
          
          echo "ðŸ“¡ Running: $RAILWAY_CMD -- echo 'Connection test successful'"
          
          if $RAILWAY_CMD -- echo 'Connection test successful'; then
            echo "âœ… Railway connection successful!"
          else
            echo "âŒ Railway connection failed!"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Verify RAILWAY_TOKEN is correct"
            echo "2. Verify service name: ${RAILWAY_SERVICE_NAME}"
            echo "3. Check that the service is running"
            echo "4. Ensure your token has access to this project"
            exit 1
          fi
        continue-on-error: false
      
      - name: Debug Railway Filesystem
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME || 'frosty-agent-forge' }}
          RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT || 'production' }}
        run: |
          echo "ðŸ” Debugging Railway filesystem..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          RAILWAY_CMD="railway ssh --service ${RAILWAY_SERVICE_NAME} --environment ${RAILWAY_ENVIRONMENT}"
          
          echo ""
          echo "1ï¸âƒ£ Current working directory:"
          $RAILWAY_CMD -- pwd
          
          echo ""
          echo "2ï¸âƒ£ Directory listing (recursive):"
          $RAILWAY_CMD -- ls -R .
          
          echo ""
          echo "3ï¸âƒ£ Finding signups.db:"
          $RAILWAY_CMD -- find / -name "signups.db" 2>/dev/null || echo "   (find command failed or no results)"
          
          echo ""
          echo "4ï¸âƒ£ Checking common paths:"
          $RAILWAY_CMD -- ls -la /data/signups.db 2>/dev/null && echo "   âœ… Found at /data/signups.db" || echo "   âŒ Not at /data/signups.db"
          $RAILWAY_CMD -- ls -la ./data/signups.db 2>/dev/null && echo "   âœ… Found at ./data/signups.db" || echo "   âŒ Not at ./data/signups.db"
          $RAILWAY_CMD -- ls -la ~/data/signups.db 2>/dev/null && echo "   âœ… Found at ~/data/signups.db" || echo "   âŒ Not at ~/data/signups.db"
          
          echo ""
          echo "5ï¸âƒ£ Checking if better-sqlite3 is available:"
          $RAILWAY_CMD -- node -e 'console.log(require("better-sqlite3"))' 2>/dev/null && echo "   âœ… better-sqlite3 is installed" || echo "   âŒ better-sqlite3 not found"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true
      
      - name: Test Database Query
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME || 'frosty-agent-forge' }}
          RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT || 'production' }}
        run: |
          echo "ðŸ§ª Testing database query command..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo ""
          echo "1ï¸âƒ£ Test simple node command:"
          railway ssh --service ${RAILWAY_SERVICE_NAME} --environment ${RAILWAY_ENVIRONMENT} -- node --version
          
          echo ""
          echo "2ï¸âƒ£ Test if base64 command exists on Railway:"
          railway ssh --service ${RAILWAY_SERVICE_NAME} --environment ${RAILWAY_ENVIRONMENT} -- which base64
          railway ssh --service ${RAILWAY_SERVICE_NAME} --environment ${RAILWAY_ENVIRONMENT} -- base64 --version
          
          echo ""
          echo "3ï¸âƒ£ Test base64 encoding/decoding:"
          railway ssh --service ${RAILWAY_SERVICE_NAME} --environment ${RAILWAY_ENVIRONMENT} -- \
            bash -c "echo 'console.log(\"Hello from Node\")' | base64 | base64 -d | node"
          
          echo ""
          echo "4ï¸âƒ£ Test database query using base64 encoding:"
          # Read the script and encode it to base64
          QUERY_SCRIPT_B64=$(cat scripts/railway-query-db.js | grep -v '^#!' | base64 -w 0)
          echo "   Base64 length: ${#QUERY_SCRIPT_B64} chars"
          echo "   First 50 chars: ${QUERY_SCRIPT_B64:0:50}..."
          
          # Execute on Railway by decoding and piping to node
          echo "   Executing..."
          railway ssh --service ${RAILWAY_SERVICE_NAME} --environment ${RAILWAY_ENVIRONMENT} -- \
            bash -c "echo '$QUERY_SCRIPT_B64' | base64 -d | node" || echo "   âŒ Command failed with exit code $?"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true
      
      - name: Echo Raw Railway Query Output
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME || 'frosty-agent-forge' }}
          RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT || 'production' }}
        run: |
          echo "ðŸ” Raw Railway Query Output (what the script sees):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Use the EXACT same escaping that works locally
          # Single quotes on outside, escaped double quotes inside
          echo "ðŸ“¡ Executing query with proper escaping (like local command)..."
          OUTPUT=$(railway ssh --service ${RAILWAY_SERVICE_NAME} --environment ${RAILWAY_ENVIRONMENT} "node -e \"const db = require('better-sqlite3')('./data/signups.db'); const all = db.prepare('SELECT * FROM signups ORDER BY created_at DESC').all(); console.log(JSON.stringify(all)); db.close();\"" 2>&1)
          
          echo "ðŸ“‹ Full output (including stderr):"
          echo "$OUTPUT"
          echo ""
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Try to parse as JSON
          echo "ðŸ§ª Attempting to parse as JSON..."
          if echo "$OUTPUT" | jq . > /dev/null 2>&1; then
            echo "âœ… Valid JSON!"
            echo "ðŸ“Š Number of records: $(echo "$OUTPUT" | jq 'length')"
            echo "ðŸ“§ First 3 emails:"
            echo "$OUTPUT" | jq -r '.[0:3] | .[] | .email'
          else
            echo "âŒ NOT valid JSON!"
            echo "This is why the script fails to parse it."
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true
      
      # Temporarily commented out to avoid wasting emails during debugging
      - name: Run full test flow
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME || 'frosty-agent-forge' }}
          RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT || 'production' }}
        run: |
          echo "ðŸ§ª Running test flow for Day ${{ github.event.inputs.day }}"
          echo "ðŸ“§ Email will be sent ONLY to rizel@block.xyz"
          echo ""
          npx tsx scripts/test-full-flow.ts --day=${{ github.event.inputs.day }}
      
      - name: Commit email list updates (if any)
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status -s data/email-list.json) ]]; then
            git add data/email-list.json
            git commit -m "Update email list from test flow (Day ${{ github.event.inputs.day }})"
            git push
            echo "âœ… Email list updated and pushed"
          else
            echo "â„¹ï¸  No changes to email list"
          fi
        continue-on-error: true
      
      - name: Create success summary
        if: success()
        run: |
          echo "## âœ… Test Email Flow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Day:** ${{ github.event.inputs.day }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Email Sent To:** rizel@block.xyz" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What was tested:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Railway database query" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Email list update" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Challenge content fetch from GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Email generation and sending" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¬ **Check your inbox at rizel@block.xyz!**" >> $GITHUB_STEP_SUMMARY
      
      - name: Create failure summary
        if: failure()
        run: |
          echo "## âŒ Test Email Flow Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Day:** ${{ github.event.inputs.day }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
