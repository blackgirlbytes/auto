name: Test Email Flow (Send to rizel@block.xyz only)

on:
  # Manual trigger only - for testing
  workflow_dispatch:
    inputs:
      day:
        description: 'Challenge day number (1-17)'
        required: true
        default: '1'

jobs:
  test-email-flow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Authenticate Railway CLI
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ðŸ” Authenticating with Railway..."
          railway login --browserless
      
      - name: Link Railway Project
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          if [ -n "$RAILWAY_PROJECT_ID" ]; then
            echo "ðŸ”— Linking to Railway project..."
            railway link $RAILWAY_PROJECT_ID
          else
            echo "âš ï¸  RAILWAY_PROJECT_ID not set, skipping project link"
          fi
        continue-on-error: true
      
      - name: Run full test flow
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ðŸ§ª Running test flow for Day ${{ github.event.inputs.day }}"
          echo "ðŸ“§ Email will be sent ONLY to rizel@block.xyz"
          echo ""
          npx tsx scripts/test-full-flow.ts --day=${{ github.event.inputs.day }}
      
      - name: Commit email list updates (if any)
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status -s data/email-list.json) ]]; then
            git add data/email-list.json
            git commit -m "Update email list from test flow (Day ${{ github.event.inputs.day }})"
            git push
            echo "âœ… Email list updated and pushed"
          else
            echo "â„¹ï¸  No changes to email list"
          fi
        continue-on-error: true
      
      - name: Create success summary
        if: success()
        run: |
          echo "## âœ… Test Email Flow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Day:** ${{ github.event.inputs.day }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Email Sent To:** rizel@block.xyz" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What was tested:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Railway database query" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Email list update" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Challenge content fetch from GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Email generation and sending" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¬ **Check your inbox at rizel@block.xyz!**" >> $GITHUB_STEP_SUMMARY
      
      - name: Create failure summary
        if: failure()
        run: |
          echo "## âŒ Test Email Flow Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Day:** ${{ github.event.inputs.day }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
