name: Test Email Flow (Send to rizel@block.xyz only)

on:
  # Manual trigger only - for testing
  workflow_dispatch:
    inputs:
      day:
        description: 'Challenge day number (1-17)'
        required: true
        default: '1'

jobs:
  test-email-flow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Debug Railway Configuration
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
          RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT || 'production' }}
        run: |
          echo "ðŸ” Railway Configuration Debug:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "RAILWAY_TOKEN: ${RAILWAY_TOKEN:+âœ… Set (${#RAILWAY_TOKEN} chars)}"
          echo "RAILWAY_PROJECT_ID: ${RAILWAY_PROJECT_ID:-âŒ Not set}"
          echo "RAILWAY_SERVICE_ID: ${RAILWAY_SERVICE_ID:-âš ï¸  Not set (optional)}"
          echo "RAILWAY_ENVIRONMENT: ${RAILWAY_ENVIRONMENT:-production}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "âŒ ERROR: RAILWAY_TOKEN is required!"
            exit 1
          fi
          
          if [ -z "$RAILWAY_PROJECT_ID" ]; then
            echo "âš ï¸  WARNING: RAILWAY_PROJECT_ID not set. Railway CLI may not find your project."
            echo "   Add it to GitHub Secrets for reliable operation."
          fi
      
      - name: Test Railway Connection
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
          RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT || 'production' }}
        run: |
          echo "ðŸ§ª Testing Railway SSH connection..."
          
          # Export RAILWAY_TOKEN so Railway CLI can use it
          export RAILWAY_TOKEN="${RAILWAY_TOKEN}"
          
          # Build the railway ssh command with all available flags
          RAILWAY_CMD="railway ssh"
          
          if [ -n "$RAILWAY_PROJECT_ID" ]; then
            RAILWAY_CMD="$RAILWAY_CMD --project $RAILWAY_PROJECT_ID"
          fi
          
          if [ -n "$RAILWAY_SERVICE_ID" ]; then
            RAILWAY_CMD="$RAILWAY_CMD --service $RAILWAY_SERVICE_ID"
          fi
          
          RAILWAY_CMD="$RAILWAY_CMD --environment ${RAILWAY_ENVIRONMENT:-production}"
          
          echo "ðŸ“¡ Running: $RAILWAY_CMD \"echo 'Connection test successful'\""
          echo "   (Token length: ${#RAILWAY_TOKEN} chars)"
          
          if $RAILWAY_CMD "echo 'Connection test successful'"; then
            echo "âœ… Railway connection successful!"
          else
            echo "âŒ Railway connection failed!"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Verify RAILWAY_TOKEN is correct"
            echo "2. Verify RAILWAY_PROJECT_ID matches your project"
            echo "3. Check that the service is running"
            echo "4. Ensure your token has access to this project"
            exit 1
          fi
        continue-on-error: false
      
      - name: Run full test flow
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
          RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT || 'production' }}
        run: |
          echo "ðŸ§ª Running test flow for Day ${{ github.event.inputs.day }}"
          echo "ðŸ“§ Email will be sent ONLY to rizel@block.xyz"
          echo ""
          npx tsx scripts/test-full-flow.ts --day=${{ github.event.inputs.day }}
      
      - name: Commit email list updates (if any)
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status -s data/email-list.json) ]]; then
            git add data/email-list.json
            git commit -m "Update email list from test flow (Day ${{ github.event.inputs.day }})"
            git push
            echo "âœ… Email list updated and pushed"
          else
            echo "â„¹ï¸  No changes to email list"
          fi
        continue-on-error: true
      
      - name: Create success summary
        if: success()
        run: |
          echo "## âœ… Test Email Flow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Day:** ${{ github.event.inputs.day }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Email Sent To:** rizel@block.xyz" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What was tested:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Railway database query" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Email list update" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Challenge content fetch from GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Email generation and sending" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¬ **Check your inbox at rizel@block.xyz!**" >> $GITHUB_STEP_SUMMARY
      
      - name: Create failure summary
        if: failure()
        run: |
          echo "## âŒ Test Email Flow Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Day:** ${{ github.event.inputs.day }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
