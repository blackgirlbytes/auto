name: Sync Signups from Railway

on:
  # Run every 3 hours
  schedule:
    - cron: '0 */3 * * *'  # Every 3 hours at minute 0
    # Extra runs before daily email send (12:30 PM ET = 17:30 UTC)
    - cron: '30 14 * * *'  # 10:30 AM ET (14:30 UTC)
    - cron: '0 15 * * *'   # 11:00 AM ET (15:00 UTC)
    - cron: '15 15 * * *'  # 11:15 AM ET (15:15 UTC)
    - cron: '30 15 * * *'  # 11:30 AM ET (15:30 UTC)
    - cron: '45 15 * * *'  # 11:45 AM ET (15:45 UTC)
  
  # Manual trigger for testing
  workflow_dispatch:

jobs:
  sync-signups:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing commits
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Sync signups from Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME || 'frosty-agent-forge' }}
          RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT || 'production' }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”„ Syncing Signups from Railway Database"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ” Railway Configuration:"
          echo "   Service: ${RAILWAY_SERVICE_NAME}"
          echo "   Environment: ${RAILWAY_ENVIRONMENT}"
          echo "   Token: ${RAILWAY_TOKEN:+âœ… Set (${#RAILWAY_TOKEN} chars)}"
          echo ""
          echo "ðŸ“¡ Querying Railway for new signups..."
          echo ""
          
          npx tsx scripts/query-new-signups.ts --commit
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: false
      
      - name: Create sync summary
        if: success()
        run: |
          echo "## âœ… Signup Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Next sync:** In 3 hours" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details on new signups." >> $GITHUB_STEP_SUMMARY
      
      - name: Create failure summary
        if: failure()
        run: |
          echo "## âŒ Signup Sync Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The sync will retry in 3 hours. Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
